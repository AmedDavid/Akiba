{% extends 'base.html' %}
{% load money %}

{% block title %}Insights - Akiba{% endblock %}

{% block content %}
<section class="py-12 px-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-serif text-vintage-dark mb-2">Spending Insights</h1>
                {% if latest and latest.period_start and latest.period_end %}
                <p class="text-sm md:text-base text-vintage-brown font-serif italic">
                    <i data-lucide="calendar" class="w-4 h-4 inline-block mr-1"></i>
                    Statement Period: {{ latest.period_start|date:"F d, Y" }} - {{ latest.period_end|date:"F d, Y" }}
                </p>
                {% elif latest %}
                <p class="text-sm md:text-base text-vintage-brown font-serif italic">
                    <i data-lucide="calendar" class="w-4 h-4 inline-block mr-1"></i>
                    Period: {{ latest.period_months }} month{{ latest.period_months|pluralize }}
                </p>
                {% endif %}
            </div>
            <a href="{% url 'upload_statement' %}" class="bg-vintage-red hover:bg-vintage-redlight text-vintage-cream px-4 md:px-6 py-2 md:py-3 font-bold tracking-widest uppercase text-xs transition-all shadow-[4px_4px_0px_0px_#2C2420] hover:translate-y-[1px] hover:shadow-[2px_2px_0px_0px_#2C2420] border border-vintage-dark whitespace-nowrap">
                Upload Statement
            </a>
        </div>

        {% if latest %}
        <!-- Latest Statement Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="arrow-down" class="w-8 h-8 text-vintage-olive"></i>
                    <span class="text-xs font-display uppercase tracking-widest text-vintage-brown">Incoming</span>
                </div>
                <p class="text-xl md:text-2xl lg:text-3xl font-serif text-vintage-dark font-bold break-words">KSh {{ latest.total_incoming|floatformat:2 }}</p>
            </div>
            <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="arrow-up" class="w-8 h-8 text-vintage-red"></i>
                    <span class="text-xs font-display uppercase tracking-widest text-vintage-brown">Outgoing</span>
                </div>
                <p class="text-xl md:text-2xl lg:text-3xl font-serif text-vintage-dark font-bold break-words">KSh {{ latest.total_outgoing|floatformat:2 }}</p>
            </div>
            <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="trending-down" class="w-8 h-8 {% if net_amount >= 0 %}text-vintage-olive{% else %}text-vintage-red{% endif %}"></i>
                    <span class="text-xs font-display uppercase tracking-widest text-vintage-brown">Net</span>
                </div>
                <p class="text-xl md:text-2xl lg:text-3xl font-serif {% if net_amount >= 0 %}text-vintage-olive{% else %}text-vintage-red{% endif %} font-bold break-words">KSh {{ net_amount|floatformat:2|default:"0.00" }}</p>
            </div>
        </div>

        <!-- Recommendations -->
        {% if recommendations %}
        <div class="mb-8 space-y-3">
            {% for rec in recommendations %}
            <div class="bg-white p-4 border-l-4 {% if rec.type == 'error' %}border-vintage-red{% elif rec.type == 'warning' %}border-yellow-500{% elif rec.type == 'success' %}border-vintage-olive{% else %}border-vintage-brown{% endif %} shadow-sm">
                <div class="flex items-start gap-3">
                    <i data-lucide="{% if rec.type == 'error' %}alert-circle{% elif rec.type == 'warning' %}alert-triangle{% elif rec.type == 'success' %}check-circle{% else %}info{% endif %}" class="w-5 h-5 {% if rec.type == 'error' %}text-vintage-red{% elif rec.type == 'warning' %}text-yellow-600{% elif rec.type == 'success' %}text-vintage-olive{% else %}text-vintage-brown{% endif %} mt-0.5 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-serif font-bold text-vintage-dark mb-1">{{ rec.title }}</h3>
                        <p class="text-sm text-vintage-brown">{{ rec.message }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Doughnut Chart - Smaller -->
            <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm">
                <h2 class="text-xl font-serif text-vintage-dark mb-4">Spending Distribution</h2>
                <div class="relative" style="height: 300px;">
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm">
                <h2 class="text-xl font-serif text-vintage-dark mb-4">Category Comparison</h2>
                <div class="relative" style="height: 300px;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Spending Categories -->
        {% if top_categories %}
        <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm mb-8">
            <h2 class="text-xl font-serif text-vintage-dark mb-4">Top Spending Categories</h2>
            <div class="space-y-3">
                {% for category, amount, percentage in top_categories %}
                <div class="flex items-center justify-between p-3 bg-vintage-cream/30 rounded">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-serif text-base text-vintage-dark">{{ category }}</span>
                            <span class="text-sm font-serif text-vintage-brown">{{ percentage|floatformat:1 }}%</span>
                        </div>
                        <div class="w-full bg-vintage-dark/10 rounded-full h-2">
                            <div class="bg-vintage-red h-2 rounded-full" style="width: {{ percentage }}%"></div>
                        </div>
                    </div>
                    <span class="ml-4 text-lg font-serif text-vintage-dark font-bold whitespace-nowrap">KSh {{ amount|floatformat:2 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Spending Categories Breakdown -->
        <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm mb-8">
            <h2 class="text-xl font-serif text-vintage-dark mb-4">Detailed Breakdown</h2>
            <div class="space-y-3">
                {% if latest.betting_spent > 0 %}
                <div class="p-4 bg-vintage-red/5 border-l-4 border-vintage-red">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2">
                        <div>
                            <span class="font-serif text-base md:text-lg text-vintage-dark break-words">Betting</span>
                            <span class="ml-2 text-xs text-vintage-brown">({{ category_percentages.betting|floatformat:1 }}%)</span>
                        </div>
                        <span class="text-lg md:text-xl font-serif text-vintage-red font-bold whitespace-nowrap">KSh {{ latest.betting_spent|floatformat:2 }}</span>
                    </div>
                    <p class="text-xs md:text-sm text-vintage-brown italic break-words">That's enough for a PS5 or a month's rent!</p>
                </div>
                {% endif %}
                
                {% if latest.airtime_spent > 0 %}
                <div class="p-4 bg-vintage-brown/5 border-l-4 border-vintage-brown">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2">
                        <div>
                            <span class="font-serif text-base md:text-lg text-vintage-dark break-words">Airtime</span>
                            <span class="ml-2 text-xs text-vintage-brown">({{ category_percentages.airtime|floatformat:1 }}%)</span>
                        </div>
                        <span class="text-lg md:text-xl font-serif text-vintage-brown font-bold whitespace-nowrap">KSh {{ latest.airtime_spent|floatformat:2 }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if latest.fuliza_spent > 0 %}
                <div class="p-4 bg-vintage-red/5 border-l-4 border-vintage-red">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2">
                        <div>
                            <span class="font-serif text-base md:text-lg text-vintage-dark break-words">Fuliza/M-Shwari</span>
                            <span class="ml-2 text-xs text-vintage-brown">({{ category_percentages.fuliza|floatformat:1 }}%)</span>
                        </div>
                        <span class="text-lg md:text-xl font-serif text-vintage-red font-bold whitespace-nowrap">KSh {{ latest.fuliza_spent|floatformat:2 }}</span>
                    </div>
                    <p class="text-xs md:text-sm text-vintage-brown italic break-words">Consider reducing credit usage to save more!</p>
                </div>
                {% endif %}
                
                {% if latest.bars_spent > 0 %}
                <div class="p-4 bg-vintage-brown/5 border-l-4 border-vintage-brown">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2">
                        <div>
                            <span class="font-serif text-base md:text-lg text-vintage-dark break-words">Bars/Restaurants</span>
                            <span class="ml-2 text-xs text-vintage-brown">({{ category_percentages.bars|floatformat:1 }}%)</span>
                        </div>
                        <span class="text-lg md:text-xl font-serif text-vintage-brown font-bold whitespace-nowrap">KSh {{ latest.bars_spent|floatformat:2 }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if latest.till_withdrawals > 0 %}
                <div class="p-4 bg-vintage-brown/5 border-l-4 border-vintage-brown">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2">
                        <div>
                            <span class="font-serif text-base md:text-lg text-vintage-dark break-words">Till Withdrawals</span>
                            <span class="ml-2 text-xs text-vintage-brown">({{ category_percentages.till_withdrawals|floatformat:1 }}%)</span>
                        </div>
                        <span class="text-lg md:text-xl font-serif text-vintage-brown font-bold whitespace-nowrap">KSh {{ latest.till_withdrawals|floatformat:2 }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if latest.other_spent > 0 %}
                <div class="p-4 bg-vintage-brown/5 border-l-4 border-vintage-brown">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2">
                        <div>
                            <span class="font-serif text-base md:text-lg text-vintage-dark break-words">Other</span>
                            <span class="ml-2 text-xs text-vintage-brown">({{ category_percentages.other|floatformat:1 }}%)</span>
                        </div>
                        <span class="text-lg md:text-xl font-serif text-vintage-brown font-bold whitespace-nowrap">KSh {{ latest.other_spent|floatformat:2 }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Transactions -->
        {% if transactions %}
        <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm mb-8">
            <h2 class="text-xl font-serif text-vintage-dark mb-4">Recent Transactions</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-vintage-cream/50">
                        <tr>
                            <th class="px-4 py-2 text-left font-serif text-vintage-dark">Date</th>
                            <th class="px-4 py-2 text-left font-serif text-vintage-dark">Description</th>
                            <th class="px-4 py-2 text-right font-serif text-vintage-dark">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in transactions %}
                        <tr class="border-b border-vintage-dark/10 hover:bg-vintage-cream/30">
                            <td class="px-4 py-2 text-vintage-brown">{{ trans.date|default:"N/A" }}</td>
                            <td class="px-4 py-2 text-vintage-dark">{{ trans.description|default:"N/A"|truncatewords:10 }}</td>
                            <td class="px-4 py-2 text-right font-serif {% if trans.amount|default:0 > 0 %}text-vintage-olive{% else %}text-vintage-red{% endif %} font-bold">
                                KSh {{ trans.amount|default:"0.00"|floatformat:2 }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Statement History -->
        {% if statements|length > 0 %}
        <div class="bg-white p-6 border border-vintage-dark/10 shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-serif text-vintage-dark">Statement History</h2>
                <span class="text-sm text-vintage-brown">{{ statements|length }} statement{{ statements|length|pluralize }}</span>
            </div>
            <div class="space-y-2">
                {% for statement in statements %}
                <div class="flex items-center justify-between p-3 border border-vintage-dark/10 hover:bg-vintage-cream/30 transition-colors {% if statement.id == latest.id %}bg-vintage-olive/5{% endif %}">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-serif text-base text-vintage-dark">{{ statement.uploaded_at|date:"F d, Y" }}</span>
                            {% if statement.id == latest.id %}
                            <span class="text-xs bg-vintage-olive text-white px-2 py-0.5 rounded">Current</span>
                            {% endif %}
                            <span class="text-xs text-vintage-brown">({{ statement.period_months }} month{{ statement.period_months|pluralize }})</span>
                        </div>
                        <div class="mt-1 text-sm">
                            <span class="font-serif text-vintage-olive">+KSh {{ statement.total_incoming|floatformat:2 }}</span>
                            <span class="mx-2 text-vintage-brown">|</span>
                            <span class="font-serif text-vintage-red">-KSh {{ statement.total_outgoing|floatformat:2 }}</span>
                        </div>
                    </div>
                    <button type="button" onclick="openDeleteModal({{ statement.id }}, '{{ statement.uploaded_at|date:"F d, Y" }}')" class="text-vintage-red hover:text-vintage-redlight transition-colors p-2" title="Delete statement">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-12 bg-white border border-vintage-dark/10 p-8">
            <i data-lucide="file-text" class="w-16 h-16 text-vintage-brown opacity-50 mx-auto mb-4"></i>
            <p class="text-vintage-brown font-serif italic mb-4">No statements uploaded yet. Upload your first M-Pesa statement to get insights!</p>
            <a href="{% url 'upload_statement' %}" class="bg-vintage-red hover:bg-vintage-redlight text-vintage-cream px-8 py-3 font-bold tracking-widest uppercase text-xs transition-all shadow-[4px_4px_0px_0px_#2C2420] hover:translate-y-[1px] hover:shadow-[2px_2px_0px_0px_#2C2420] border border-vintage-dark inline-block">
                Upload Statement
            </a>
        </div>
        {% endif %}
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-[#F5F2E9] border-2 border-vintage-dark/20 shadow-lg max-w-md w-full p-8 space-y-6">
        <div class="flex items-center justify-between">
            <h3 class="text-2xl font-serif text-vintage-dark font-bold">Delete Statement</h3>
            <button onclick="closeDeleteModal()" class="text-vintage-dark hover:text-vintage-red transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <p class="text-vintage-brown font-serif">
                Are you sure you want to delete the statement from <span id="deleteStatementDate" class="font-bold text-vintage-dark"></span>?
            </p>
            <p class="text-sm text-vintage-brown italic">
                This action cannot be undone. The PDF file will also be permanently deleted.
            </p>
            
            <form id="deleteForm" method="post" class="space-y-3">
                {% csrf_token %}
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteModal()" class="flex-1 py-3 px-6 bg-vintage-dark/10 hover:bg-vintage-dark/20 text-vintage-dark font-display uppercase tracking-widest text-sm transition-colors border border-vintage-dark/20">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 py-3 px-6 bg-vintage-red hover:bg-vintage-redlight text-white font-display uppercase tracking-widest text-sm transition-colors">
                        Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if latest %}
{% block extra_js %}
<script>
(function() {
    // Doughnut Chart - Smaller size
    const spendingCtx = document.getElementById('spendingChart');
    if (spendingCtx) {
        if (window.spendingChartInstance) {
            window.spendingChartInstance.destroy();
        }
        window.spendingChartInstance = new Chart(spendingCtx, {
            type: 'doughnut',
            data: {
                labels: ['Betting', 'Airtime', 'Fuliza', 'Bars', 'Till Withdrawals', 'Other'],
                datasets: [{
                    data: [
                        {{ latest.betting_spent }},
                        {{ latest.airtime_spent }},
                        {{ latest.fuliza_spent }},
                        {{ latest.bars_spent }},
                        {{ latest.till_withdrawals }},
                        {{ latest.other_spent }}
                    ],
                    backgroundColor: [
                        '#782221',
                        '#5D4037',
                        '#9B2C2C',
                        '#556B2F',
                        '#C5A059',
                        '#2C2420'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                family: 'DM Sans',
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    // Bar Chart
    const barCtx = document.getElementById('barChart');
    if (barCtx) {
        if (window.barChartInstance) {
            window.barChartInstance.destroy();
        }
        const categories = ['Betting', 'Airtime', 'Fuliza', 'Bars', 'Till Withdrawals', 'Other'];
        const amounts = [
            {{ latest.betting_spent }},
            {{ latest.airtime_spent }},
            {{ latest.fuliza_spent }},
            {{ latest.bars_spent }},
            {{ latest.till_withdrawals }},
            {{ latest.other_spent }}
        ];
        
        window.barChartInstance = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Amount (KSh)',
                    data: amounts,
                    backgroundColor: [
                        '#782221',
                        '#5D4037',
                        '#9B2C2C',
                        '#556B2F',
                        '#C5A059',
                        '#2C2420'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'KSh ' + value.toLocaleString();
                            },
                            font: {
                                family: 'DM Sans',
                                size: 11
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                family: 'DM Sans',
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Delete Modal Functions
    window.openDeleteModal = function(statementId, statementDate) {
        document.getElementById('deleteStatementDate').textContent = statementDate;
        document.getElementById('deleteForm').action = `/statements/${statementId}/delete/`;
        document.getElementById('deleteModal').classList.remove('hidden');
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    };
    
    window.closeDeleteModal = function() {
        document.getElementById('deleteModal').classList.add('hidden');
    };
    
    document.getElementById('deleteModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeDeleteModal();
        }
    });
})();
</script>
{% endblock %}
{% endif %}
{% endblock %}
