<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Akiba - Smart Savings Tracker{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;500;700&family=Playfair+Display:ital,wght@0,400;0,500;0,700;0,900;1,400;1,600&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'DM Sans', sans-serif; }
        h1, h2, h3, h4, h5, h6, .font-serif { font-family: 'Playfair Display', serif; }
        .font-display { font-family: 'Cinzel', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Aged Paper Texture */
        .bg-texture {
            background-color: #F5F2E9;
            background-image:
                linear-gradient(0deg, transparent 24%, rgba(120, 34, 33, .03) 25%, rgba(120, 34, 33, .03) 26%, transparent 27%, transparent 74%, rgba(120, 34, 33, .03) 75%, rgba(120, 34, 33, .03) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(120, 34, 33, .03) 25%, rgba(120, 34, 33, .03) 26%, transparent 27%, transparent 74%, rgba(120, 34, 33, .03) 75%, rgba(120, 34, 33, .03) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
        }
        /* Vintage Photo Filter */
        .vintage-filter {
            filter: sepia(0.3) contrast(1.1) brightness(0.9);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        vintage: {
                            cream: '#F5F2E9',
                            dark: '#2C2420',
                            brown: '#5D4037',
                            red: '#782221',
                            redlight: '#9B2C2C',
                            olive: '#556B2F',
                            gold: '#C5A059'
                        }
                    },
                    backgroundImage: {
                        'paper-pattern': "url('https://www.transparenttextures.com/patterns/cream-paper.png')"
                    }
                }
            }
        }
    </script>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-vintage-cream text-vintage-dark antialiased selection:bg-vintage-red selection:text-white bg-texture">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 bg-[#F5F2E9]/95 backdrop-blur-sm border-b-2 border-vintage-dark/10">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 h-16 sm:h-20 md:h-24 flex items-center justify-between relative">
            <!-- Logo -->
            <a href="{% if user.is_authenticated %}{% url 'dashboard' %}{% else %}{% url 'landing' %}{% endif %}" class="flex items-center gap-1 md:gap-2 group flex-shrink-0">
                <i data-lucide="piggy-bank" class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 text-vintage-red stroke-[1.5]"></i>
                <div class="flex flex-col">
                    <span class="text-lg sm:text-xl md:text-2xl font-black font-serif tracking-tighter text-vintage-dark leading-none">Ak<span class="text-vintage-red italic font-normal">iba</span></span>
                    <span class="text-[8px] sm:text-[9px] md:text-[10px] uppercase tracking-[0.2em] text-vintage-brown font-display hidden sm:block">Smart Savings</span>
                </div>
            </a>
            
            {% if user.is_authenticated %}
            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center gap-6 lg:gap-8 text-xs font-bold text-vintage-dark tracking-[0.15em] uppercase font-display">
                <!-- Main Navigation -->
                <a href="{% url 'dashboard' %}" class="hover:text-vintage-red transition-colors relative group">
                    Dashboard
                    <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-vintage-red transition-all group-hover:w-full"></span>
                </a>
                <a href="{% url 'goals' %}" class="hover:text-vintage-red transition-colors relative group">
                    Goals
                    <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-vintage-red transition-all group-hover:w-full"></span>
                </a>
                <a href="{% url 'insights' %}" class="hover:text-vintage-red transition-colors relative group">
                    Insights
                    <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-vintage-red transition-all group-hover:w-full"></span>
                </a>
                <a href="{% url 'tribes' %}" class="hover:text-vintage-red transition-colors relative group">
                    Tribes
                    <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-vintage-red transition-all group-hover:w-full"></span>
                </a>
                
                <!-- Gamification Dropdown -->
                <div class="relative group" id="gamify-dropdown">
                    <button type="button" class="hover:text-vintage-red transition-colors flex items-center gap-1 cursor-pointer">
                        Gamify
                        <i data-lucide="chevron-down" id="gamify-chevron" class="w-4 h-4 transition-transform"></i>
                    </button>
                    <div id="gamify-menu" class="absolute top-full left-0 pt-1 w-48 opacity-0 invisible pointer-events-none transition-all duration-200 z-50">
                        <div class="bg-[#F5F2E9] border-2 border-vintage-dark/20 shadow-lg py-2">
                            <a href="{% url 'achievements' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Achievements
                            </a>
                            <a href="{% url 'challenges' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Challenges
                            </a>
                            <a href="{% url 'leaderboard' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Leaderboard
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Tools Dropdown -->
                <div class="relative group" id="tools-dropdown">
                    <button type="button" class="hover:text-vintage-red transition-colors flex items-center gap-1 cursor-pointer">
                        Tools
                        <i data-lucide="chevron-down" id="tools-chevron" class="w-4 h-4 transition-transform"></i>
                    </button>
                    <div id="tools-menu" class="absolute top-full left-0 pt-1 w-48 opacity-0 invisible pointer-events-none transition-all duration-200 z-50">
                        <div class="bg-[#F5F2E9] border-2 border-vintage-dark/20 shadow-lg py-2">
                            <a href="{% url 'analytics' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Analytics
                            </a>
                            <a href="{% url 'budget' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Budget
                            </a>
                            <a href="{% url 'calculator' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Calculator
                            </a>
                            <a href="{% url 'recurring_plans' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Recurring Plans
                            </a>
                            <a href="{% url 'goal_templates' %}" class="block px-4 py-2 hover:bg-vintage-red/10 hover:text-vintage-red transition-colors text-sm">
                                Goal Templates
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Desktop User Actions -->
            <div class="hidden md:flex items-center gap-4 lg:gap-6">
                {% if user.is_authenticated %}
                    {% if not user.subscription.is_pro %}
                        <a href="{% url 'pricing' %}" class="bg-vintage-gold hover:bg-vintage-gold/90 text-vintage-dark px-3 py-1.5 font-display uppercase tracking-widest text-xs transition-all shadow-[2px_2px_0px_0px_#2C2420] hover:translate-y-[1px] hover:shadow-[1px_1px_0px_0px_#2C2420] border border-vintage-dark">
                            Upgrade
                        </a>
                    {% endif %}
                {% endif %}
                <a href="{% url 'notifications' %}" class="relative hover:text-vintage-red transition-colors text-vintage-dark" title="Notifications">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    {% if unread_count > 0 %}
                    <span class="absolute -top-1 -right-1 bg-vintage-red text-white text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center">{{ unread_count }}</span>
                    {% endif %}
                </a>
                <a href="{% url 'profile' %}" class="flex items-center gap-2 hover:text-vintage-red transition-colors text-vintage-dark" title="Profile">
                    {% if user.userprofile.avatar %}
                        <img src="{{ user.userprofile.avatar.url }}" alt="Profile" class="w-8 h-8 rounded-full border-2 border-vintage-red object-cover">
                    {% else %}
                        <i data-lucide="user" class="w-5 h-5"></i>
                    {% endif %}
                </a>
                <a href="{% url 'logout' %}" class="hover:text-vintage-red transition-colors text-vintage-dark" title="Logout">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </a>
            </div>
            
            <!-- Mobile Menu Button & User Actions -->
            <div class="md:hidden flex items-center gap-3">
                <a href="{% url 'profile' %}" class="flex items-center hover:text-vintage-red transition-colors text-vintage-dark">
                    {% if user.userprofile.avatar %}
                        <img src="{{ user.userprofile.avatar.url }}" alt="Profile" class="w-7 h-7 rounded-full border-2 border-vintage-red object-cover">
                    {% else %}
                        <i data-lucide="user" class="w-5 h-5"></i>
                    {% endif %}
                </a>
                <button id="mobile-menu-btn" type="button" class="text-vintage-dark hover:text-vintage-red transition-colors p-1" aria-label="Toggle menu">
                    <i data-lucide="menu" id="menu-icon" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Mobile Menu Dropdown -->
            <div id="mobile-menu" class="hidden md:hidden absolute top-full left-0 right-0 bg-[#F5F2E9] border-b-2 border-vintage-dark/10 shadow-lg max-h-[80vh] overflow-y-auto">
                <div class="px-4 py-4 space-y-1">
                    <!-- Main Navigation -->
                    <a href="{% url 'dashboard' %}" class="block py-3 px-4 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                        Dashboard
                    </a>
                    <a href="{% url 'goals' %}" class="block py-3 px-4 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                        Goals
                    </a>
                    <a href="{% url 'insights' %}" class="block py-3 px-4 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                        Insights
                    </a>
                    <a href="{% url 'tribes' %}" class="block py-3 px-4 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                        Tribes
                    </a>
                    
                    <!-- Gamification Section -->
                    <div class="border-t border-vintage-dark/10 mt-2 pt-2">
                        <p class="px-4 py-2 text-xs font-display uppercase tracking-widest text-vintage-brown">Gamification</p>
                        <a href="{% url 'achievements' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Achievements
                        </a>
                        <a href="{% url 'challenges' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Challenges
                        </a>
                        <a href="{% url 'leaderboard' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Leaderboard
                        </a>
                    </div>
                    
                    <!-- Tools Section -->
                    <div class="border-t border-vintage-dark/10 mt-2 pt-2">
                        <p class="px-4 py-2 text-xs font-display uppercase tracking-widest text-vintage-brown">Tools</p>
                        <a href="{% url 'analytics' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Analytics
                        </a>
                        <a href="{% url 'budget' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Budget
                        </a>
                        <a href="{% url 'calculator' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Calculator
                        </a>
                        <a href="{% url 'recurring_plans' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Recurring Plans
                        </a>
                        <a href="{% url 'goal_templates' %}" class="block py-2 px-6 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red">
                            Goal Templates
                        </a>
                    </div>
                    
                    <!-- User Section -->
                    <div class="border-t border-vintage-dark/10 mt-2 pt-2">
                        <a href="{% url 'notifications' %}" class="block py-3 px-4 text-sm font-bold text-vintage-dark tracking-[0.15em] uppercase font-display hover:bg-vintage-dark/5 hover:text-vintage-red transition-colors border-l-2 border-transparent hover:border-vintage-red relative">
                            Notifications
                            {% if unread_count > 0 %}
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 bg-vintage-red text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">{{ unread_count }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'logout' %}" class="block py-3 px-4 text-sm font-bold text-vintage-red tracking-[0.15em] uppercase font-display hover:bg-vintage-red/10 transition-colors">
                            Logout
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Guest Navigation -->
            <div class="flex items-center gap-3 sm:gap-4 md:gap-6">
                <a href="{% url 'login' %}" class="hover:text-vintage-red transition-colors text-vintage-dark font-display uppercase tracking-widest text-[10px] sm:text-xs whitespace-nowrap">Login</a>
                <a href="{% url 'register' %}" class="bg-vintage-red hover:bg-vintage-redlight text-vintage-cream px-3 sm:px-4 md:px-6 py-1.5 sm:py-2 font-bold tracking-widest uppercase text-[10px] sm:text-xs transition-all shadow-[4px_4px_0px_0px_#2C2420] hover:translate-y-[1px] hover:shadow-[2px_2px_0px_0px_#2C2420] border border-vintage-dark whitespace-nowrap">
                    Register
                </a>
            </div>
            {% endif %}
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="fixed top-16 sm:top-20 md:top-24 right-2 md:right-6 z-50 space-y-2 max-w-xs md:max-w-md">
        {% for message in messages %}
        <div class="bg-vintage-cream border-2 {% if message.tags == 'error' %}border-vintage-red bg-vintage-red/5{% elif message.tags == 'success' %}border-vintage-olive bg-vintage-olive/5{% else %}border-vintage-dark{% endif %} shadow-[4px_4px_0px_0px_#2C2420] p-3 md:p-4 animate-slide-in">
            <div class="flex items-start gap-2 md:gap-3">
                {% if message.tags == 'error' %}
                    <i data-lucide="alert-circle" class="w-4 h-4 md:w-5 md:h-5 text-vintage-red flex-shrink-0 mt-0.5"></i>
                {% elif message.tags == 'success' %}
                    <i data-lucide="check-circle" class="w-4 h-4 md:w-5 md:h-5 text-vintage-olive flex-shrink-0 mt-0.5"></i>
                {% else %}
                    <i data-lucide="info" class="w-4 h-4 md:w-5 md:h-5 text-vintage-brown flex-shrink-0 mt-0.5"></i>
                {% endif %}
                <span class="font-serif text-xs md:text-sm break-words flex-1">{{ message }}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="text-vintage-brown hover:text-vintage-red transition-colors flex-shrink-0">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    <script>
        // Auto-dismiss messages after 5 seconds
        setTimeout(() => {
            document.querySelectorAll('.fixed .space-y-2 > div').forEach(msg => {
                msg.style.transition = 'opacity 0.3s, transform 0.3s';
                msg.style.opacity = '0';
                msg.style.transform = 'translateX(100%)';
                setTimeout(() => msg.remove(), 300);
            });
        }, 5000);
    </script>
    {% endif %}

    <!-- Main Content -->
    <main class="pt-16 sm:pt-20 md:pt-24">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-vintage-dark text-vintage-cream pt-24 pb-12 px-6 border-t-[8px] border-vintage-red mt-24">
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 mb-20">
            <div class="space-y-6">
                <div class="flex items-center gap-2">
                    <i data-lucide="piggy-bank" class="w-6 h-6 text-vintage-red"></i>
                    <span class="text-2xl font-bold font-serif tracking-tight text-white block">Ak<span class="text-vintage-red italic font-normal">iba.</span></span>
                </div>
                <p class="text-sm leading-relaxed max-w-xs text-vintage-cream/60 font-serif">
                    Smart savings goal tracker with M-Pesa analysis. Build your future, one shilling at a time.
                </p>
            </div>
            <div>
                <h4 class="font-display font-bold uppercase tracking-widest text-xs mb-8 text-vintage-gold">Features</h4>
                <ul class="space-y-4 text-sm font-serif italic text-vintage-cream/80">
                    <li><a href="{% url 'goals' %}" class="hover:text-vintage-red transition-colors">Savings Goals</a></li>
                    <li><a href="{% url 'insights' %}" class="hover:text-vintage-red transition-colors">M-Pesa Insights</a></li>
                    <li><a href="{% url 'tribes' %}" class="hover:text-vintage-red transition-colors">Tribes</a></li>
                    <li><a href="{% url 'leaderboard' %}" class="hover:text-vintage-red transition-colors">Leaderboards</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-display font-bold uppercase tracking-widest text-xs mb-8 text-vintage-gold">Account</h4>
                <ul class="space-y-4 text-sm font-serif italic text-vintage-cream/80">
                    {% if user.is_authenticated %}
                    <li><a href="{% url 'profile' %}" class="hover:text-vintage-red transition-colors">Profile</a></li>
                    <li><a href="{% url 'dashboard' %}" class="hover:text-vintage-red transition-colors">Dashboard</a></li>
                    {% else %}
                    <li><a href="{% url 'login' %}" class="hover:text-vintage-red transition-colors">Login</a></li>
                    <li><a href="{% url 'register' %}" class="hover:text-vintage-red transition-colors">Register</a></li>
                    {% endif %}
                </ul>
            </div>
            <div class="space-y-6">
                <h4 class="font-display font-bold uppercase tracking-widest text-xs mb-2 text-vintage-gold">About</h4>
                <p class="text-sm text-vintage-cream/60 font-serif">Track your savings, analyze spending, and achieve your goals with your community.</p>
            </div>
        </div>
        <div class="max-w-7xl mx-auto pt-8 border-t border-vintage-cream/10 flex flex-col md:flex-row justify-between items-center gap-4 text-[10px] tracking-[0.2em] uppercase text-vintage-cream/40 font-display">
            <p>&copy; {% now "Y" %} Akiba. All rights reserved.</p>
        </div>
    </footer>

    <script>
        lucide.createIcons({
            attrs: {
                'stroke-width': 1.5
            }
        });
        
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = document.getElementById('menu-icon');
        
        if (mobileMenuBtn && mobileMenu && menuIcon) {
            mobileMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = mobileMenu.classList.contains('hidden');
                if (isHidden) {
                    mobileMenu.classList.remove('hidden');
                    menuIcon.setAttribute('data-lucide', 'x');
                } else {
                    mobileMenu.classList.add('hidden');
                    menuIcon.setAttribute('data-lucide', 'menu');
                }
                lucide.createIcons();
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                    menuIcon.setAttribute('data-lucide', 'menu');
                    lucide.createIcons();
                }
            });
            
            // Close menu when clicking a link
            mobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.add('hidden');
                    menuIcon.setAttribute('data-lucide', 'menu');
                    lucide.createIcons();
                });
            });
        }
        
        // Desktop dropdown menus
        const gamifyDropdown = document.getElementById('gamify-dropdown');
        const gamifyMenu = document.getElementById('gamify-menu');
        const gamifyChevron = document.getElementById('gamify-chevron');
        const toolsDropdown = document.getElementById('tools-dropdown');
        const toolsMenu = document.getElementById('tools-menu');
        const toolsChevron = document.getElementById('tools-chevron');
        
        let gamifyTimeout = null;
        let toolsTimeout = null;
        
        function showDropdown(menu, chevron) {
            if (menu && chevron) {
                menu.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                menu.classList.add('opacity-100', 'visible', 'pointer-events-auto');
                chevron.style.transform = 'rotate(180deg)';
            }
        }
        
        function hideDropdown(menu, chevron, delay = 100) {
            if (menu && chevron) {
                setTimeout(() => {
                    menu.classList.remove('opacity-100', 'visible', 'pointer-events-auto');
                    menu.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                    chevron.style.transform = 'rotate(0deg)';
                }, delay);
            }
        }
        
        function cancelHide(timeout) {
            if (timeout) {
                clearTimeout(timeout);
            }
        }
        
        if (gamifyDropdown && gamifyMenu && gamifyChevron) {
            gamifyDropdown.addEventListener('mouseenter', () => {
                cancelHide(gamifyTimeout);
                showDropdown(gamifyMenu, gamifyChevron);
            });
            
            gamifyDropdown.addEventListener('mouseleave', () => {
                gamifyTimeout = setTimeout(() => {
                    hideDropdown(gamifyMenu, gamifyChevron, 0);
                }, 150);
            });
            
            // Keep open when hovering over menu
            gamifyMenu.addEventListener('mouseenter', () => {
                cancelHide(gamifyTimeout);
                showDropdown(gamifyMenu, gamifyChevron);
            });
            
            gamifyMenu.addEventListener('mouseleave', () => {
                hideDropdown(gamifyMenu, gamifyChevron, 0);
            });
        }
        
        if (toolsDropdown && toolsMenu && toolsChevron) {
            toolsDropdown.addEventListener('mouseenter', () => {
                cancelHide(toolsTimeout);
                showDropdown(toolsMenu, toolsChevron);
            });
            
            toolsDropdown.addEventListener('mouseleave', () => {
                toolsTimeout = setTimeout(() => {
                    hideDropdown(toolsMenu, toolsChevron, 0);
                }, 150);
            });
            
            // Keep open when hovering over menu
            toolsMenu.addEventListener('mouseenter', () => {
                cancelHide(toolsTimeout);
                showDropdown(toolsMenu, toolsChevron);
            });
            
            toolsMenu.addEventListener('mouseleave', () => {
                hideDropdown(toolsMenu, toolsChevron, 0);
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (gamifyDropdown && !gamifyDropdown.contains(e.target) && gamifyMenu && gamifyChevron) {
                hideDropdown(gamifyMenu, gamifyChevron, 0);
            }
            if (toolsDropdown && !toolsDropdown.contains(e.target) && toolsMenu && toolsChevron) {
                hideDropdown(toolsMenu, toolsChevron, 0);
            }
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>

